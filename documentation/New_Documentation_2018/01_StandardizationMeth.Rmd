---
title:   |
    | Standardization & Balancing
    | for Food Balance Sheet Calculation
    |  
header-includes:
- \usepackage{draftwatermark}   
- \usepackage{makeidx}
- \makeindex
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{amsthm}
- \usepackage{mathtools}
- \usepackage{caption}
author:
- Cristina Muschitiello\

  Food and Agriculture Organization of the United Nations
  
abstract: |
  This vignette provides a description of the Standardization and Balancing Procedure: This represents the process of aggregating and balancing all the accounts of individual products to their primary equivalents. Other documents will cover the overall Food Balance Sheet workflow and some, more detailed, technical aspect.
date: "`r format(Sys.time(), '%e %B %Y')`"
geometry: margin=1in
output:
  pdf_document:
    keep_tex: true
    fig_caption: yes
    includes:
      in_header: header.tex
    pandoc_args: [
    --tab-stop=2
    ]
    number_sections: true
    toc: true
    toc_depth: 4
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# local({
# r <- getOption("repos")
# r["faoswsCRAN"] <- "http://hqlprsws1.hq.un.fao.org/fao-sws-cran/"
# options(repos = r)
# })
## load the library
# library(faosws)
# library(faoswsUtil)
# library(faoswsBalancing)
# library(faoswsStandardization)
library(tinytex)
library(data.table)
library(igraph)
library(stringr)
library(dplyr)
library(MASS) 
library(lattice)
library(reshape2)
library(kableExtra)
library(captioner)
library(xtable)
```


```{r}
# DEFINE ALL TABLE NAMES AND CAPTIONS
table_nums <- captioner::captioner(prefix = "Table")

t15_cap <- table_nums(name = "t15", 
                        caption = "Commodity Tree - China/Wheat/2014 example")

t1_cap <- table_nums(name = "t1",
                     caption = "Unbalanced Sua table - China/Wheat/2014 example")
t2_cap <- table_nums(name = "t2", 
                        caption = "Sua table with Imb1 - China/Wheat/2014 example")

t3_cap <- table_nums(name = "t3", 
                        caption = "Sua table with Production filled/incremented - China/Wheat/2014 example")

t4_cap <- table_nums(name = "t4", 
                        caption = "Commodity Tree  with weights - China/Wheat/2014 example")

t5_cap <- table_nums(name = "t5", 
                        caption = "Sua table with Food Processing filled - China/Wheat/2014 example")

t6_cap <- table_nums(name = "t6", 
                        caption = "Sua table with Imb2 - China/Wheat/2014 example")

t7_cap <- table_nums(name = "t7", 
                        caption = "Sua table with Utilizations filled - China/Wheat/2014 example")

t8_cap <- table_nums(name = "t8", 
                        caption = "*Utilization Table* Wheat and meslin Flour - China/Wheat/2014 example")

t9_cap <- table_nums(name = "t9", 
                        caption = "*Utilization Table* Bran of Wheat - China/Wheat/2014 example")

t10_cap <- table_nums(name = "t10", 
                        caption = "Rank Weight of the elements of FBS")

t11_cap <- table_nums(name = "t11", 
                        caption = "Sua line of Cocoa Beans Madagascar 2014 - before *Sua Filling*")

t12_cap <- table_nums(name = "t12", 
                        caption = "*Utilization Table* for Cocoa Beans Madagascar")

t13_cap <- table_nums(name = "t13", 
                        caption = "Sua line of Cocoa Beans Madagascar 2014 - after *Sua Filling*")

t14_cap <- table_nums(name = "t14", 
                        caption = "Sua Balanced - China/Wheat/2014 example")

t19_cap <- table_nums(name = "t19", 
                        caption = "Sua Unbalanced DES - China/Wheat/2014 example")

t16_cap <- table_nums(name = "t16", 
                        caption = "Generic SUA for Standardization")

t17_cap <- table_nums(name = "t17", 
                        caption = "Availabilities and shares of parent/child for Standardization")

t20_cap <- table_nums(name = "t20", 
                        caption = "DES of *Sua Standardized* - China/Wheat/2014 example")

t18_cap <- table_nums(name = "t18", 
                        caption = "Sua Standardized")

t21_cap <- table_nums(name = "t21", 
                        caption = "Measurement Errors percentages")

t22_cap <- table_nums(name = "t22", 
                        caption = "Final Balancing - China/Wheat/2014 - Wheat")

t24_cap <- table_nums(name = "t24", 
                        caption = "Final Balancing - China/Wheat/2014 - Food Preparations")

t23_cap <- table_nums(name = "t23", 
                        caption = "Fbs Tree WHEAT & PRODUCTS and MAIZE & PRODUCTS")

t25_cap <- table_nums(name = "t25", 
                        caption = "FBS Final Aggregations - China/Wheat/2014")

```

\newpage

\listoftables

\listoffigures

\newpage

## Disclaimer {-}

This Working Paper should not be reported as representing the official view of
the FAO. The views expressed in this Working Paper are those of the
author and do not necessarily represent those of the FAO or FAO
policy. Working Papers describe research in progress by the authors and
are published to elicit comments and to further discussion.

This paper is dynamically generated on \today{} and is subject to
changes and updates.


# The Food Balance Sheet Framework {-}

## Definitions {-}

A food balance sheet can be defined as an aggregated and analytical data set that "presents a comprehensive picture of the pattern of a country's food supply during a specified reference period."^[For this definition and a more extended description of the motivation behind the development of FBS, see FAO, 2001, *Food Balance Sheets: A Handbook*, available at: http://www.fao.org/docrep/003/X9892E/X9892E00.HTM. Accessed on 19 January 2017.] FBS are presented as products accounts, where the quantities allocated to all the sources of total supply must be equal to the quantities allocated to all the sources of utilization. This balance is compiled for every food item consumed within a country at primary commodity equivalent basis, and all of the primary commodity equivalent balances are then combined into a single overall FBS. FBSs are, then, expressed in terms of per capita supply for each food item by dividing by the country's population, with the per capita supplies being expressed both in terms of quantity and, through the application of food conversion factors, in terms of caloric value, protein, and fat content. These per capita estimates of caloric value for individual food products are then summed to obtain the total daily per capita Dietary Energy Supply (DES) of a country.

While FBS are typically only published at the primary commodity equivalent level to facilitate interpretation, they are created for all the commodities, accordingly to the *Central Product Classification* (***CPC***) System^[The CPC represents a comprehensive classification of products into a system of categories that are both exhaustive and mutually exclusive. It is based on a set of internationally agreed concepts, definitions, principles and classification rules. The custodian of this classification is the UNSD. For more information, see the  [*Guidelines on International Classifications for Agricultural Statistics*](http://gsars.org/wp-content/uploads/2015/12/Guidelines-for-Int-Classifications-on-Agricultural-Statistics-web.pdf) and the [*UNSD official document on CPC Version 2.1*](https://unstats.un.org/unsd/cr/downloads/CPCv2.1_complete%28PDF%29_English.pdf)].
Indeed, a balance for wheat alone would in most cases include little or no food use, because wheat is commonly processed into flour before it is consumed by humans, and flour is then used to produce various other derived products such as bread, pastries and pasta. Because there is both supply and demand both for the primary commodity and the derived commodities, individual accounts are kept for all of products. 
Individual accounts for commodities are called *Supply-Utilization Accounts* (***SUA***) and the process of obtaining FBS starting from SUAs is the ***Standardization & Balancing*** process. 

## The Balancing equation and its variables {-}

At the most basic level, Food Balance Sheets are, like all commodity balances, simple identities. In these identities, the sum of all supply variables is equal to the sum of all demand variables; the two most common identities set domestic supply equal to domestic demand (first equation) or total supply equal to total demand (second equation). 

\begin{equation}
\label{eq:balance1}
P_{ijt} + I_{ijt} - X_{ijt} - \Delta St_{ijt} = FP_{ijt} + Fo_{ijt} + Fe_{ijt} + Lo_{ijt} + Se_{ijt} + IU_{ijt} + T_{ijt}  + ROU_{ijt}
\end{equation}
\begin{equation}
\label{eq:balance2}
P_{ijt} + I_{ijt} - \Delta St_{ijt} = X_{ijt} + FP_{ijt} + Fo_{ijt} + Fe_{ijt} + Lo_{ijt} + Se_{ijt} + IU_{ijt} + T_{ijt} + ROU_{ijt}
\end{equation}

where the $i$ index runs over all countries, the $j$ index over all commodities, and $t$ over years and where, dropping indices for brevity:

 * $P$=Production
 * $I$=Imports
 * $X$=Exports
 * $S$=Stock level
 * $\Delta St_{t}$ = Stock Variation = $St_{t} - St_{t-1}$
 * $FP_{ijt}$ = Food Processing
 * $Fo$=Food availability 
 * $Fe$=Feed
 * $Lo$=Losses
 * $Se$=Seed 
 * $IU$=industrial use 
 * $T$=Tourist consumption 
 * $ROU$=Residual Other Use
 * $TS = Total supply =  P_{ijt} + I_{ijt} - \Delta St_{ijt}$


All variables are expressed in the same measurement unit: ***metric tonnes***.
At international level, the primary data source that FAO uses to compile the the Supply Utilization Accounts/Food Balance Sheets are the data as collected through the annual *Agriculture Production Questionnaires*. Unfortunately, measured values are mostly limited to variables on the supply side (production, imports and exports), while, on the demand side, most values are imputed data^[For more details on FBS variables please see the latest version of the *Resource Book*, the documentation on *Food Balance Sheet workflow in the Statistical Working System* to be found on [*GitHub*](https://github.com/SWS-Methodology/faoswsStandardization/tree/master/documentation) and [*Bitbucket*](https://sdlc.fao.org/bitbucket/projects) and specific documentation available about imputation of all variables]:

# Commodity Tree {-}

The process of combining commodity balances for creating Food Balance Sheets is based on a structured and clear set of relationships between commodity given by the *Commodity tree*.
The majority of the commodities are produced from one (or more) commodity (/ies), called *parent* commodity(/ies), and/or are themselves parent of one (or more) *child* (*children*) commodity (/ies). These structure creates an intense and articulated network of relationships at different levels: primary commodities, like crops, are *parent* commodities and, also, *zero-level* commodities from which *children* commodities of *level-1* are produced, which are in turn, used to produce other commodities of a gradually *"lower"* level. In commodity trees, the bigger the level number, the lower the processing level. There are as many commodity trees as the number of process chains in a country. Fundamental characteristics of commodity trees are^[For a more detailed description of commodity trees, please see the specific documentation. The reference document, at the moment is the *tecnical conversion factor* document available in the documentation folder on [*GitHub*](https://github.com/SWS-Methodology/faoswsStandardization/tree/master/documentation)]: 

 1. Each commodity tree is represented as a flowchart of the kind presented in Figure \ref{fig:f2} where:
  * ***nodes*** represent commodities, 
  * ***edges*** represent production processes ,
  * ***joints*** indicate where a single production process creates more that one commodity. These commodities are, then, called *by-products* or *co-products*.

```{r f2, fig.align = "center", fig.pos = "H",  fig.cap = "\\label{fig:f2}Commodity Tree for Wheat in China mainland 2014"}

knitr::include_graphics("images/StandBal/02_WheatTree.pdf")
```


 2. Not all the countries have the same production processes, because countries have different technologies and primary products availabilities. Therefore, the commodity trees are not the same across countries.
 
 3. if a production process is active in a country, this is expressed through the existence of a conversion factor called ***extraction Rate***. An Extraction rate ($eR$) represents how much amount of the child commodity is produced from 1 unit of parent commodity. It is expressed as a ratio of the processed product obtained from the processing of the parent/originating product.
  
 4. Some child commodities can be produced starting from more that one parent commodity. A second conversion factor exists representing the amount of a child commodity that is produced from each parent commodity. This conversion factor is called ***Share***. Shares represent the amount of the child commodity that is produced from the specified parent and are expressed as a ratio. Shares are generically defined as: 
 
> \begin{equation}
\label{eq:sharesGen}
s_{cp} = \frac{availability_{p(c)}}{\sum \limits_{p=1}^A{availability_{p(c)}}}
\end{equation}

> where $availability_{p(c)}$ is the availability of each parent $p$ of child $c$ expressed in terms of $c$ (in *child equivalent*).

Commodity trees are presented in tables like `r table_nums("t15",display = "cite")`, which represents the same example of Figure \ref{fig:f2}. In the table each production process is represented in a separate row. 

```{r t15, fig.cap=t15_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/15_TreeChinaWheat.csv"))
knitr::kable(table,caption = "Commodity Tree - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1)))

```

There are some concepts linked to the *Commodity tree* framework: 

 * ***Proxy-Primary*** commodities. These are a set of commodities that are children of other commodities but, because they are important in representing the food availability of a country, are not aggregated to their primary commodities, but are kept separated. These commodities are *cut* from the tree of the primary commodity/ies and, if they can be processed in other products, have their own commodity tree. The name *proxy-primary* is assigned because they are considered as primary-commodities in the *Standardization & Balancing* process.
 * ***No-Tree*** commodities. These are *zero-level* commodities that are primary commodities and are never processed in other products. As they are not involved in any production process, there is no tree associated to them. Notice that, even a commodity that is included in the commodity tree of one Country, might be a No-tree commodity for another country or another year, if no production processes have been activated for that specific Country or year.

# Standardization and Balancing {-}

The *Standardiation & Balancing* process is presented in Figure \ref{fig:f9}. It involves 5 main steps and requires a some auxiliary information table. 

The 5 steps are: 

 1. Data Pull, 
 2. Sua Filling,
 3. Standardization, 
 4. Balancing,
 5. FBS aggregation. 

The additional information's tables are: 

 * *Utilization Table*,
 * *Zero-Weight* table,
 * *cut* table,
 * *Fbs Tree*.
 
```{r f9, fig.align = "center", fig.pos = "H",out.width = "80%",  fig.cap = "\\label{fig:f9}Standardization and Balancing Overall Workflow"}

knitr::include_graphics("images/StandBal/09_overall.pdf")
```


# Data Pull

The process of creating FBSs starts by considering the initial commodity balance for each CPC commodity, either primary and derived, with the different variables of the equation (as listed and briefly described in the previous section) filled with figures as available from official or other sources and from imputation and estimation methods, when applied. In other words, the process starts by pulling figures inside a so-called *Sua Unbalanced*.
In this initial account, food processing and ROU figures are not available (because they, by default, will be measured during the process), whereas the figures for all other variables have been already collected, imputed and estimated through a specific *module* (Figure \ref{fig:f1}).

A ***module***, in the FBS Framework, is an R-script, written by an R-developer, for the execution of a set of operations (either data import, manipulation, imputation or estimation) required for compiling the time series of one variable. There is at least one module (there might be more) for each variable of the FBS. Each module produces figures that are collected in a dataset inside the ***Statistical Working System (SWS)***^[SWS is an internal Working System providing a platform for statisticians and statistical clerks to collect, collate, validate and correct data. Moreover, the platform supports the possibility of performing imputations of data based on statisticians' knowledge and development.].Output data of a module may become input data of another module, this circumstance creating a precise sequence for the execution of a complete FBS. In the present document, we are analyzing the workflow of the Standardization process as starts after all the modules have run and have produced reliable data or each variable. The detailed description of the workflow for the execution of all the modules of the FBS will be given in a separate document.^[[report the document when it will be available]].

```{r f1, fig.cap = "\\label{fig:f1}Data Pull from datasets containing data for each separate variable"}
knitr::include_graphics("images/StandBal/01_pulldata.pdf")
```



## The Initial Sua Unbalanced {-}

After pulling all data, the process of compiling Food Balance Sheets is a non-complete supply-utilization account. The non-completeness of the SUAs is due to different reasons: first, as already said, some variables are not collected, nor estimated before the process begins, second there is the model for industrial use that does not impute or estimate data, but just collects data from different sources, this opening the strong possibility not to have values where they are supposed to exist and, also, not guaranteeing consistency of data over time. Thirdly, modules might, sometimes, fail in the imputation, because of the strong complexity and structural diversity of the input data. 

```{r t1, fig.cap=t1_cap}
table=data.table(read.csv("tables/StandBal/01_sua_unbalanced.csv"))
landscape(knitr::kable(table,format="latex",caption = "Unbalanced Sua table - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  row_spec(1, italic=TRUE) %>%
  column_spec(1,width = "12em")%>%
  column_spec(2:length(colnames(table)),width = "6em")%>%
  add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "alphabet")
```

Supply utilization accounts are typically organized into tables where the SUA for the primary commodity is at the top, and the SUAs for all of the products derived from that commodity follow (`r table_nums("t1", display = "cite")`). Commodities in the SUA table are in a parent-child relationship representing a real commodity process. In the example of `r table_nums("t1",display = "cite")` the relationship between commodities is the following:

 + Maize is processed in flour, Bran and Breakfast Cereals,
 + Flour of maize is processed into Starch and Gluten, Wafers, pastry, bread and pasta
 + Starch is processed into Glucose and Dextrose, 
 + Gluten and Bran are processed into some feed and meal,

All these relationships represent the *Commodity tree* of wheat in China in 2014. In particular, our example represents the commodity tree of Wheat in China in 2014 and is displayed, in its graphical form, in Figure \ref{fig:f2}.

There are unbalanced SUAs for all combinations of commodity tree/country/year. 

# The *Sua Filling*

## Main rules and the rationale {-}

The Standardization, i.e. the conversion of the variables of any child commodity in primary-equivalent commodity, requires all variables of the SUAs to be filled (except for ROU, which is a residual variable and is imputed at the very last step of the process), "all variables" meaning "all variables that are supposed to be filled". Indeed, not all variables have to exist for all commodities. Consider maize as an example: if there is no figure of *food availability* for maize, that does not mean that there is a missing figure because maize is rarely used for human consumption directly. However, in some country people do eat raw maize and, therefore, for those countries, a food figure is expected and, if missing, that has to be taken into account. 

A simplified workflow of *Sua Filling* is reported in Figure \ref{fig:f3}. 

```{r f3, fig.align = "center", fig.pos = "H", out.width = "60%", fig.cap = "\\label{fig:f3}The Sua Filling simplified workflow"}

knitr::include_graphics("images/StandBal/03_SuaFilling.pdf")

```

*Food Processing* needs to be computed first and it does not come from any module. For the food processing to be correctly computed, a check on the other variables has to be performed, in order to be sure that the food processing might be correctly imputed. In particular, Production is checked first, as the *Food Processing* figure of any commodity is based on the production one. Then *Food processing* can be computed and, after that, other missing figures, if existing, are filled.

This last step requires two major and not straightforward steps, representing each a separate issue, for solving which, an algorithm has been developed that responds to the following rationale and rules:

1. *Identify which are the missing values that have to be filled.*
2. *Decide how to fill those missing values.*
3. *Preserving reliability of sources of data*

Not all the variables (supplies and Utilizations) are to be filled:

 * Trade (import and Export) data are shared with countries and published by FAO. Therefore these figures have a separate process of validation that makes them reliable enough not to be questioned during the standardization process.
 * Production figures of primary commodities are also published by FAO. As previously mentioned, production values can have various flags which assign different degrees of reliability to these figures. The *Sua Filling* treats production figures accordingly to flags. 
 * Stock figures are also not touched during the process of filling. This decision was taken because the standardization process works year by year, while *stock variation* is a time-based variable that has to be always treated looking at the data over time. The cross year approach is incompatible with this characteristic. Any inconsistent or missing value for stock found would require to go back to the module imputing figures and check for possible errors. If no errors can be found, a manual correction would be required. 
 
Information about the remaining variables, which are all Utilizations, is taken from FBSs and SUAs of past years. 
FBSs published with the previous methodology and their corresponding SUAs can give information about which are the Utilizations supposed to be active for every single commodity in each country.  
Therefore, these pieces of information have to be given externally, as the process is automated and there is non-human knowledge intervening in training the machine that is performing the calculations. The previous methodology used for compiling FBS made massive use of manual interventions while the new methodology tries to avoid it, but taking advantage of the work and effort of the country experts that compiled the FBSs in the past. Past information is embedded in the new methodology through the use of the *Utilization Table* which helps to identify which variables have to be filled, commodity by commodity, while the amount of them to be assigned to figures is identified through a set of rules, known as *Sua Filling*. This procedure makes use of the imbalance between supply and utilization values for each commodity and fills the figures that have been recognized as missing from the ***Utilization Table***. The filling procedure assigns figures using an ad-hoc algorithm, called ***Inverse Ranking***, designed for dimensioning the figures in accordance with the importance they had in the past FBSs, as suggested also from the *Utilization Table* through ranks associated to each variable. As a consequence, all the commodities entering the *Sua Filling* procedure are eventually balanced.  

Not all the commodities enter the process the same way. In particular, a distinction is made between primary commodities and derived commodities: 

 * Primary commodities are normally the commodities for which more reliable figures are produced. Moreover, FAO often publishes information about primary commodities, therefore values are not expected to be modified during a computational process.
 * Derived commodities are more affected by modifications during this process, according to the flag of each figure. 

Therefore, the steps of *Sua Filling* process affect the SUA differently from line to line. Figure \ref{fig:f4} shows the general Workflow of the *Sua Filling* highlighting the distinction between primary and derived commodities.


```{r f4, fig.align = "center", out.width = "65%", fig.cap = "\\label{fig:f4}The Sua Filling diversified workflow"}

knitr::include_graphics("images/StandBal/04_SuaFilling2.pdf")

```


## Step 1: Filling of production figures {-}

Only Derived commodities are involved in this process. The *Sua Filling* detects the Production figures that need to be filled or modified, by looking at the following *Imbalance*: 

\begin{equation}
\label{eq:imbalance1}
Imb1_{ijt} = P_{ijt} + I_{ijt} - X_{ijt}
\end{equation}

where $Imb1_{ijt}$ is the Imbalance and is enumerated because is different from a second Imbalance that will enter into the process later. Here: 

 * If $Imb1_{ijt} < 0$ there is no supply enough for the export and this is interpreted as the need for creating/increment the Production figure. The new production figure ($P^*_{ijt}$) is computed as: 
 
 \begin{equation}
\label{eq:imbalance1}
 P^*_{ijt} = P_{ijt} + Imb1_{ijt}
\end{equation}
 
 * If $Imb1_{ijt} >= 0$ there is enough supply and, therefore, no need for changing the production figure. 

The reason for excluding other Variables from the computation of the imbalance here is that, at this step of the process, Trade variables are the most reliable and those for which, to the highest level of probability, there are all the figures filled. In `r table_nums("t2",display = "cite")` *Imb1* of our example is reported. Notice that there are 3 rows with negative values, but one of them is considered a Primary commodity. Indeed, *Mixes and dough for the preparation of baker's wares* is a commodity never processed and, therefore, is considered primary commodity and added to wheat in the FBS item *Wheat and produts*. Consequently production of only 2 commodity is changes, as shown in `r table_nums("t3",display = "cite")`.

```{r t2, fig.cap=t2_cap}
table=data.table(read.csv("tables/StandBal/02_sua_unbalanced_imb.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua table with Imb1 - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  # row_spec(c(3,4,6),bold=FALSE, italic=FALSE,color = "red") %>%
  column_spec(3:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "12em")%>%
  column_spec(14,color = "red",bold=T,italic=T)%>%
add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "alphabet")
```


```{r t3, fig.cap=t3_cap}
table=data.table(read.csv("tables/StandBal/03_sua_unbalanced_prod.csv"))
knitr::kable(table,format="latex",caption = "Sua table with Production filled/incremented - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  row_spec(c(4,6),bold=T, italic=T,color = "red") %>%
  # column_spec(2,color = "red",width = "6em")%>%
  column_spec(3:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "12em")%>%
  add_footnote(c("P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses","Starred figures are those that have changed from the previous table"),notation = "alphabet")%>%
  landscape()
```


## Step 2: Filling of food processing {-}

When Production has been checked, created or incremented, *Food Processing* can be calculated. Food processing is the amount of the supply of a commodity processed into derived commodities. *Food processing* is calculated for all the parent commodities as the sum of the food processing of all the possible derived commodities. For example, Wheat in China is processed into Flour of Wheat, Bran of Wheat and Breakfast Cereals: Flour and Bran are produced during the same production process (they are called *co-products* or *by-products*), therefore the same amount of wheat is used for producing all of them, Breakfast Cereals comes from a separate production process instead. Therefore, *Food processing* of Wheat is given as the sum of the amount of wheat's supply used for producing Flour and Bran + The amount used for producing Breakfast Cereals. Calculation of Food processing happens by level, then after having calculated the amount for wheat, the amount of supply of flour of wheat used for producing Starch, Gluten, bread and the other derived of wheat flour becomes the *Food processing* of flour of Wheat and so on, for any subsequent level. 

The formula for calculating $FP$ is based on the production of the child product: 

 \begin{equation}
\label{eq:Food Processing}
FP_{pjt} = \sum \limits_{c=1}^C\biggl(\frac{P_{cjt}}{eR_{p\to c}}\biggr)\times s^{1}_{cp}\times w_{c}
\end{equation}

where: 

 * $FP_{pjt}$ is *Food processing* of the generic parent $p$.
 * $c = 1,2,3...C$ are the $C$ children $c$ of parent $p$.
 * $P_{cjt}$ is the Production of Child $c$.
 * $eR_{p\to c}$ is the *extraction Rate* from parent $p$ to child $c$. 
 * $s^{1}_{cp}$ is the *share* of child $c$ from parent $p$ specific for Food Processing calculation. It is defined as: 

> \begin{equation}
\label{eq:shares}
s^{1}_{cp} = \frac{availability1_{p(c)}}{\sum \limits_{p=1}^A{availability1_{p(c)}}}
\end{equation}

> where $availability1_{p(c)}$ is the availability of each parent $p$ of child $c$ expressed in terms of $c$ (as say in *child equivalent*). Is is enumerated as $1$ because a slighlty different availability will be found in a following step: 

>>\begin{equation}
\label{eq:availability 1}
availability1_{p(c)} = (P_{pjt} + I_{pjt})\times eR_{p\to c}
\end{equation}


 * $w_{c}$ is the *weight* of child $c$. This parameter is used for identifying and treating co-products. Indeed, if the production of two or more co-products is used for producing *Food processing* of the parent commodity producing them, the result would be a Food processing twice the size of what it should be. This would happen because the two co-products are produced during the same process, in other words, from the same amount of the parent commodity. For this to be taken into account, a weight is used, which is 1 for the commodity that has to be considered for determining Food processing of parent commodity and 0 for the child commodity that are co-products (equation \ref{eq:weight}). Please notice that, the co-products are still important in the standardization, because they contribute in the creation of the calories availability of the country, therefore, these commodities (Also called *zero weight* commodities) are multiplied by 0 only when quantities are treated, they will instead be considered when calories will be taken into account: 
 
>>\begin{equation}
\label{eq:weight}
\begin{cases}
    w_{c} = 1      & \quad \text{if both quantity and calories have to be standardized} \\
    w_{c} = 0      & \quad \text{if only calories have to be standardized}
\end{cases}
\end{equation}


The following Table reports the commodity tree of the *China/Wheat/2014* example with the extra-column reporting the *weight* of each child-commodity.

```{r t4, fig.cap=t4_cap}
table=data.table(read.csv("tables/StandBal/04_foodproc_calc.csv"))
knitr::kable(table,caption = "Commodity Tree  with weights - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1)))

```

Shares lower than $1$ mean that the child commodity might be produced also from other parents and, therefore, the reported ratio represents the ratio of that commodity that is produced from the reported parent. For example, *Gluten Feed and Meal* is produced from *Wheat Gluten* and from *Bran of maize*. The sum of the shares associated to this child ($0.33$ and $0.67$) is equal to $1$.

`r table_nums("t5",display = "cite")` shows the SUA table after the two steps just described. Notice that, in the specific example, there was no need for the creation/increase of Production on any derived commodity because $Imb1$ is positive for all commodities. 

From `r table_nums("t4",display = "cite")` and `r table_nums("t5",display = "cite")` here is, as example, the computation of *Food processing* of Wheat,Flour of wheat and Starch of wheat: 

\begin{equation}
\begin{multlined}
\label{eq:wheatFP}
FP_{wheatChina2014} = \left(70,500,000/0.78\right)\times 1\times 1 +\left(21,414,729/0.8\right)\times 1\times 0 = 90,384,615
\end{multlined}
\end{equation}

\begin{equation}
\begin{multlined}
\label{eq:flourFP}
FP_{flourChina2014} = \left(1,415,692/1\right)\times 1\times 1 +\left(15,486/1\right)\times 1\times 1 
+\left(193,950/1\right)\times 1\times 1
+\\
\left(239,816/0.75\right)\times 1\times 1 +
\left(116,496/1\right)\times 1\times 0 +\left(13,263/1\right)\times 1\times 1= 1,958,146
\end{multlined}
\end{equation}


\begin{equation}
\begin{multlined}
\label{eq:starchFP}
FP_{starchChina2014} = \left(158,665/1\right)\times 1\times 1 +\left(21,414,729/0.8\right)\times 1\times 0 = 158,665
\end{multlined}
\end{equation}


```{r t5, fig.cap=t5_cap}
table=data.table(read.csv("tables/StandBal/05_sua_unbalanced_2.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua table with Food Processing filled - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  column_spec(1,width = "12em")%>%
  column_spec(2:length(colnames(table)),width = "6em")%>%
  column_spec(7,italic=TRUE,bold=T,color = "red")%>%
  add_footnote(c("P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses","Starred figures are those that have changed from the previous table"),notation = "alphabet")

```




## Step 3: Filling of other missing Utilizations {-}

After *Food processing* figures have been computed, the other variables have to be checked and either filled, increased or decreased. Only derived commodities enter this step. Primary commodities are excluded because, for these commodities, the figures are normally more reliable and complete and, very often protected. Only the final balancing may affect Primary commodity figures.
This step is based on the value of the following Imbalance:

\begin{equation}
\label{eq:imbalance2}
Imb2_{ijt} = P_{ijt} + I_{ijt} - X_{ijt} - \Delta St_{ijt} - FP_{ijt} - Fo_{ijt} - Fe_{ijt} - Lo_{ijt} - Se_{ijt} - IU_{ijt} - T_{ijt}
\end{equation}

`r table_nums("t6",display = "cite")` reports $Imb2$ for all the lines of the SUAs of our example. 

Three different scenarios con be found (Figure 5): 

```{r f5, fig.align = "center", out.width = "80%", fig.cap = "\\label{fig:f5}Scenarios of the Sua Filling"}

knitr::include_graphics("images/StandBal/05_ScenariosFilling.pdf")

```


```{r t6, fig.cap=t6_cap}
table=data.table(read.csv("tables/StandBal/06_sua_unbalanced_imb2.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua table with Imb2 - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  column_spec(3:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "10em")%>%
  column_spec(14,color = "red",bold=T, italic=T)%>%
add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "alphabet")
```

Please notice that, besides export and stock Variations, that are excluded from this step for the reasons previously explained, also Food Processing is excluded from the next steps, because $FP$ is related to the production figures of the children and to modify it, would detach this very important parent-children link. 

### *Imbalance = 0 (Scenario A)* {-}

In this scenario, the Imbalance is null, this meaning that there is enough supply for the existing utilization. In this case, the SUA line is balanced and nothing happens for the commodity. In `r table_nums("t6",display = "cite")` this is the case of *Other Fructose and syrup* and *wheat Gluten*.


### *Imbalance < 0 (Scenario B)* {-}

If this happens, it means that there is not enough supply for the commodity to be used in the way the SUA figures suggest. In this case, as shown in Figure \ref{fig:f6} the algorithm tries to solve the excess of utilization by reducing all the existing Utilizations by 30% (except Exports^[Stock is changed in this case, because this is just a proportional reduction of values and does not need a time series analysis]). If this is enough to cover the Utilization, the balancing line for that commodity is balanced and the process can go to the next step. Instead, after this reduction, there might be 2 different scenarios: 

 1. If this imbalance is still negative, it is checked if the production figure is "*protected*" or not: 
 

> -- If Production figure is not protected, it is interpreted as if there was not enough information for producing a correct production number, therefore, this figure is changed, i.e. created, if missing, or incremented of an amount equal to *Imb2*

> -- If Production figure is protected, a warning is given that tells that there is an unsolvable problem and that all figures have to be checked because either the production protected figure is wrong, or the Trade or some utilization have to be changed. 

 
 2. If the imbalance becomes positive, the line falls into the Scenario C that will be explained shortly.


*Starch of Wheat* belongs to this very last case. Indeed, it has a negative Imbalance, therefore, its Utilizations (except those Utilizations that are completely excluded from this process) are reduced by 30% of their values (see `r table_nums("t7", display = "cite")`). After that happens, the Imb2 is recalculated and it is still negative, equal to $74,204$ (this value is not reported in the table). In the following step, as the production is not protected, the new value of production is equal to: 

\begin{equation}
\label{eq:prod}
P_{StarchChina2014} = 239,816 + 74,204 = 314,020
\end{equation}

Remember that the commodity *Mixes and dough for the preparation of baker's wares* is considered here as a primary commodity, therefore it will not be balanced even if it has a negative imbalance.

```{r f6, fig.align = "center", fig.cap = "\\label{fig:f5}Workflow of Sua Filling when there is a negative imbalance"}

knitr::include_graphics("images/StandBal/06_NegativeImbalance.pdf")

```

```{r t7, fig.cap=t7_cap}
table=data.table(read.csv("tables/StandBal/07_sua_unbalanced_imb2B.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua table with Utilizations filled - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  column_spec(3:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "10em")%>%
  column_spec(14,color = "red",bold=T, italic=T)%>%
  add_footnote(c("P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses","Starred figures are those that have changed from the previous table"),notation = "alphabet")
```


### *Imbalance > 0 (Scenario C)* {-}

When $Imb2 >0$ there is an excess of supply that has to be distributed through Utilizations. Here:  

 * A *Utilization Table* tells which figures are supposed to be filled.
 * The Imbalance is distributed among variables according to a, so called, *Multiple Filler approach* which make use of the *Inverse Ranking Rule*. 
 

### --> The *Utilization Table* {-}

*Utilization Table* is a Country/commodity table telling which Utilizations historically have been active for each commodity and assigning a Rank and an inverse rank to each utilization based on its mean value over the period 2000-2013. `r table_nums("t8",display = "cite")` shows the *Utilization Table* for *Wheat and meslin flour* in China Mainland.


```{r t8, fig.cap=t8_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/08_FlourWheatUtilizationT.csv"))
knitr::kable(table,caption = "*Utilization Table* Wheat and meslin Flour - China/Wheat/2014 example",
             align = c(rep("c",length(colnames(table))-1)))

```

Where $1248$ is the m49 code for China Mainland and $23110$ is the CPC code of Wheat and Meslin Flour. The table tells the following pieces of information: 

 1. The reported commodity in China, as been historically used:
  * for producing other commodities (*Food Processing*),
  * for human consumption (*Food*),
  * for increasing stocks (*Stock Variation*),
  * for exports (*exports*).
 2. The biggest amount of availability of the reported commodity was used for Human consumption, the second big for processing other commodities, then for exports and, in the end, for increasing stocks.

These pieces of information are combined with the amount of *Imb2* for filling the SUAs of each derived commodity according to a set of rules all falling into the, so called, *Multiple Filler approach*.

### --> The *Multiple Filler Approach* and the *Inverse Ranking Rule* {-}

This approach distributes the $Imb2$ across Utilizations, by the rules reported in Figure \ref{fig:f7}.


```{r f7, fig.align = "center",  fig.cap = "\\label{fig:f5}Workflow of Sua Filling when there is a positive imbalance"}

knitr::include_graphics("images/StandBal/07_PositiveImbalance.pdf")

```

As reported in the Figure, Three cases may happen: 

1. If all the ranked Utilizations are already filled, all of them are increased proportionally to their values. *Bran of Wheat* in our example, belongs to this case. *Utilization Table* for Bran of Wheat is reported in `r table_nums("t9",display = "cite")`


```{r t9, fig.cap=t9_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/09_BranWheatUtilizationT.csv"))
knitr::kable(table,caption = "*Utilization Table* Bran of Wheat - China/Wheat/2014 example",
             align = c(rep("c",length(colnames(table))-1)))

```
  

> According to this table, there are 3 Utilizations that are suppose to be active for this commodity: *feed*, *food* and *exports*. *Exports* is excluded from this step, therefore, food and feed reamain. Both Variables are filled in the SUA line of This Commodity, therefore, all of them are increased proportionally to their values. 

2. If all the ranked Utilizations are already filled but one, the all imbalance goes to that commodity. In our Example, this is the case of *Gluten Feed and meals* (`r table_nums("t9",display = "cite")`).


3. Finally, if more that one utilization is empty, the so called ***Inverse Ranking rule*** is activated. This rule assigns part of the imbalance to the ranked Utilizations proportionally to the ranks. This happens by making use of the inverse rank of all the Utilizations that are "activable" and not excluded from the procedure. The rule works for any number of ranks and independently from the number of Utilizations that have to be excluded. 

> The *Inverse ranking rule* starts from the *Utilization Table* with the addition of a column containing the *rank weigth $Wr$*, as reported in the following table: 


> \begin{center}
\begin{tabular}{ c|c|c|c } 
 \hline
element ($Ut_{h}$) & rank ($r_{h}$) & Inverse rank ($Ir_{h}$) & weight Rank ($Wr_{h}$)\\
 \hline
$Ut_{1}$ & $r_{1}$ & $Ir_{1}$  & $Wr_{1}$\\ 
... & ... & ... & ...\\ 
$Ut_{h}$ & $r_{h}$ & $Ir_{h}$  & $Wr_{h}$\\ 
... & ... & ... & ...\\ 
$Ut_{n}$ & $r_{n}$ & $Ir_{n}$  & $Wr_{n}$\\ 
 \hline
\end{tabular}
\end{center}

> where: 

> * $Ut_{h}$ is the generic utilization, with $h=1,2,...n$
> * $r_{h}$ is the rank of utilization $Ut_{h}$, with $h=1,2,...n$
> * $hr_{h}$ is the Inverse rank of utilization $Ut_{h}$, with $h=1,2,...n$ and is equal to: 

>> \begin{equation}
\label{eq:inverseRankequation}
Ir_{h} = max(r)-r_{h}+1
\end{equation} 

> * $Wr_{h}$ is the rank weight of utilization $Ut_{h}$ and is equal to 0 or 1 depending on the element being, respectively, exluded or not from the *Sua Filling* (`r table_nums("t10",display = "cite")`). 

```{r t10, fig.cap=t10_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/10_RankWeightTable.csv"))
knitr::kable(table,caption = "Rank Weight of the elements of FBS",
             align = c(rep("c",length(colnames(table))-1)))

```


> The value $V_{h}$ assigned to the Utilizations of each commodity is calculated as a rank based proportion $pR_{h}$ of the total $Imb2$ according to the following equation:

> \begin{equation}
\label{eq:inverseRank}
V_{h} = Imb2 \times pR_{h}
\end{equation}

> with $pR_{h}$ depending on $\sum \limits_{h=1}^n Wr_{h}$:


> \begin{equation}
\label{eq:weightRank}
\begin{cases}
   pR_{h} = 0     & \quad \text{when} \quad \sum \limits_{h=1}^n Wr_{h} = 0\\
   pR_{h} = \frac{Ir_{h}\times we_{h}}{\sum \limits_{i=1}^n\left(Ir_{h}\times Wr_{h}\right)}     & \quad \text{when} \quad \sum \limits_{h=1}^n Wr_{h} > 0 
\end{cases}
\end{equation}

> 
> 

> As an example consider the SUA line of *Cocoa Beans* in Madagascar in 2014 (`r table_nums("t11",display = "cite")`) and the *Utilization Table* of the same country/commodity combination (`r table_nums("t12",display = "cite")`)

```{r t11, fig.cap=t11_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/11_cocoaBeans.csv"))
knitr::kable(table,caption = "Sua of Cocoa Beans Madagascar 2014 - before *Sua Filling*",
             align = c(rep("c",length(colnames(table))-1)))

```

```{r t12, fig.cap=t12_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/12_cocoaUtilizationT.csv"))
knitr::kable(table,caption = "*Utilization Table* for Cocoa Beans Madagascar",
             align = c(rep("c",length(colnames(table))-1)))

```

> Besides the excluded elements, there are 2 Utilizations empty: *food* and *Industrial Use*. The Values $V_{Fo}$ and $V_{IU}$ of these two elements are calculated as follows and the result shown in `r table_nums("t13",display = "cite")`: 

> \begin{equation}
\begin{aligned}
  pR_{Fo} &= \frac{4\times 1}{0 + 0 + 4 + 3 + 0 + 0} = 4/7 = 0.57143 \\
  V_{Fo} &= 1,832 \times 0.57143 = 1,047 
\end{aligned}
\end{equation}

> 

> \begin{equation}
\begin{aligned}
\label{eq:VIUC}
  pR_{IU} &= \frac{3\times 1}{0 + 0 + 4 + 3 + 0 + 0} = 3/7 = 0.42857\\
  V_{IU} &= 1,832 \times 0.42857 = 785
\end{aligned}
\end{equation}


```{r t13, fig.cap=t13_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/13_cocoaBeansBal.csv"))
knitr::kable(table,caption = "Sua line of Cocoa Beans Madagascar 2014 - after *Sua Filling*",
             align = c(rep("c",length(colnames(table))-1)))

```

## The "Sua Balanced" table {-}

The table resulting after the *Sua Filling* is called *Sua Balanced*. For the  *China/Wheat/2014* example the *Sua Balanced* is reported in `r table_nums("t14",display = "cite")`.

The red lines are not balanced lines. Indeed, the *Sua Filling* procedure does not intervene on all the commodities. It leaves unbalanced all the "top level" commodities falling in 2 main categories:

 1. The *Primary commodities*. These are all the crop commodities, like cereals, pulses, vegetables, fruits etc, that are often processed in other commodities, like the wheat in flour of wheat.
 2. The *no tree* commodities. These commodities are excluded from the list of commodities that are processed into something else, they are often mixes of some other crop or commodity and used for specific purposes, i.e. *Mixes and dough for the preparation of baker's wares* and *Food preparations of Flour, Meal or Malt Extract* from our example.

 
Therefore  3 lines are not balanced in `r table_nums("t14",display = "cite")`, belonging to these 2 categories of "not balanced" commodities.

```{r t14, fig.cap=t14_cap}
table=data.table(read.csv("tables/StandBal/14_sua_Balanced.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua Balanced - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  row_spec(c(1,3,9),color = "red",bold=T, italic=T ) %>%
add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "alphabet")
```


The reason for the exclusion of the *zero-level* commodities form the filling stays in the circumstance for which the standardization will affect the figures of the primary commodities, this opening the need for a final *balancing* procedure. In order not to intervene twice on these commodities, it has been decide to keep as smaller as possible the number correction, so to reduce error. 

## Nutritive Values and DES calculation {-}

After the *sua Balanced* table has been produced, ***Nutritive values*** are calculated (*Calories*, *Proteins* and *Fats*), based on the Food availability produced during the *Sua Filling*. These Variables are calculated for each Food Product of the SUA, based on official Nutritive Factors stored in the SWS. 
Values of Nutritive elements are stored in the system as: 

* $g/100g$, for Proteins and Fats
* $Kcal/100g$ for Calories.

As a consequence, the amount of Nutritive Elements for the number of Tonnes of Food is given by


\begin{equation}
\label{eq:Nutritive}
\text{Nutritive value} = \text{Nutritive factor} \times \text{Food availability (tonnes)} \times 10,000
\end{equation}

In particular, after all Nutritive Values are calculated, only DES is reported for FBS's purposes, DES being given by: 

\begin{equation}
\label{eq:des}
 DES_{ijt} = \cfrac{\cfrac{Kcal_{ijt}}{Population_{jt}}}{365}
\end{equation}

where the $i$ index runs over all countries, the $j$ index over all commodities, and $t$ over years.

DES for the food commodities in the *China/Wheat/2014* example are reported in `r table_nums("t19",display = "cite")`


```{r t19, fig.cap=t19_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/19_desSuaBalanced.csv"))
knitr::kable(table,caption = "Sua Unbalanced DES - China/Wheat/2014 example",
             align = c(rep("c",length(colnames(table))-1)))
```

Figure \ref{fig:f8} Represents the steps following the *Sua Filling*: 


```{r f8, fig.align = "center", fig.pos = "H",  fig.cap = "\\label{fig:f8}Sua Balanced and the calculation of DES"}

knitr::include_graphics("images/StandBal/08_SuaBalanced.pdf")

```


# Standardization

The *Standardization* is the process of transforming all the processed commodities in terms of their primary (or *proxy-primary*) commodities and to add up all the calories of the food commodities, so to have all the existing food availability of a country, expressed in terms of the main commodities. Aggregation of data from a detailed product classification to a more comprehensive one is common practice for two reasons. The first reason is to reduce the amount of data, and the number of commodities involved, to a level and size more suited for analytical purposes. The second reason is, that by cancelling out the intermediate production of derived products against the input use of primary products, a clearer view emerges of the domestic availability of a product and its final uses.

The standardization starts from the SUA table (reported, in its generic form, in `r table_nums("t16",display = "cite")`)

```{r t16, fig.cap=t16_cap, fig.pos = "H",results="asis"}

```

\begin {table}[H]
\begin{center}
\caption {Generic SUA for Standardization}

\begin{tabular}{lllllllllllll}
& & & & & \\
 \hline
Item & $El_{1}$ & ... & $El_{h}$ & ...& $El_{n}$ & $Kcal$\\ 
 \hline
$parent_{p}$ & $V_{El_{1,pjt}}$ & ...& $V_{El_{h,pjt}}$ & ...& $V_{El_{n,pjt}}$ & $Kcal_{pjt}$\\ 
$child_{1}$ & $V_{El_{1,jt1}}$ & ... & $V_{El_{h,jt1}}$ & ...& $V_{El_{n,jt1}}$ & $Kcal_{1jt}$\\ 
... & ... & ... & ... & ... & ... & ... & \\ 
$child_{c}$ & $V_{El_{1,cjt}}$ & ... & $V_{El_{h,cjt}}$ & ...& $V_{El_{n,cjt}}$ & $Kcal_{cjt}$\\ 
... & ... & ... & ... & ... & ... & ... & \\ 
$child_{C}$ & $V_{El_{1,Cjt}}$ & ... & $V_{El_{h,Cjt}}$ & ...& $V_{El_{n,Cjt}}$ & $Kcal_{pjt}$\\ 
 \hline
\end{tabular}
\end{center}
\end {table}


where: 

 * $c = 1,2,3...C$ are the $C$ children $c$ of parent $p$,
 * $V_{El_{h,cjt}}$ is Value of element $h$ for child  $c$,
 * $V_{El_{h,pjt}}$ is Value of element $h$ for parent  $p$,
 * $El_{h}$ is the generic Element of the generic child $c$ of Parent $p$ in the range of elements involved in the Standardization. Indeed, $P$ and $FP$ are excluded from this step of the process,
 * $Kcal$ is the amount of Calories associated with the commodity. This is positive only if the commodity is a food commodity.

Standardize a SUA is the process of:

 a. expressing all elements $El_{k,c}$ of the children of a parent commodity, in terms of their parent commodity,
 b. Adding up all the calories of the food commodities and calculate DES.
 
 
Elements are transformed in their parent commodity following the equation:  


\begin{equation}
\begin{cases}
\label{eq:Food Processing}
 El_{h,pjt} = \sum \limits_{c=1}^C\biggl(\frac{V_{El_{h,cjt}}}{eR_{p\to c}}\biggr)\times s^{2}_{cp}\times w_{c}\\
  \\
 DES_{pjt} =  \cfrac{\cfrac{Kcal_{pjt} + \sum \limits_{c=1}^C Kcal_{cjt}}{Population_{jt}}}{365}
\end{cases}
\end{equation}

> where: 

 * $c = 1,2,3...C$ are the $C$ children $c$ of parent $p$,
 * $eR_{p\to c}$ is the *extraction Rate* from parent $p$ to child $c$, 
 * $w_{c}$ is the *weight* of child $c$,
 * $Kcal_{pjt}$ are the Kcal of the parent commodity (if is a food commodity),
 * $Kcal_{cjt}$ are the Kcal of the child commodities,
 * $s^{2}_{cp}$ is the *share* of child $c$ from parent $p$ and is based on a different availability from the previous one: 

\begin{equation}
\label{eq:shares}
s^{2}_{cp} = \cfrac{availability2_{p(c)}}{\sum \limits_{p=1}^A{availability2_{p(c)}}}
\end{equation}


> where $availability2_{p(c)}$ is the availability of each parent $p$ of child $c$ expressed in terms of $c$ (as say in *child equivalent*). Is is enumerated as $2$ because is different from the one previously defined. Indeed, here The availability of each parent is the amount of that commodity available to be processed, i.e. the Food processing, expressed in terms of child, therefore:

>>\begin{equation}
\label{eq:availability2}
availability2_{p(c)} = FP_{pjt}\times eR_{p\to c}
\end{equation}


`r table_nums("t17",display = "cite")` shows the values of $availability2$, $eR$ and *shares* and *weights* of the *China/Wheat/2014* example.

```{r t17, fig.cap=t17_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/17_Availability2.csv"),check.names = FALSE)
knitr::kable(table,caption = "Availabilities and shares of parent/child for Standardization",
             align = c(rep("c",length(colnames(table))-1)))

```

As you can see, comparing this table with `r table_nums("t14",display = "cite")`: 

\begin{equation}
\label{eq:avExample1}
availability2_{wheat(flour)} = 90,384,615\times 0,78 = 70,500,000
\end{equation}

\begin{equation}
\label{eq:avExample2}
availability2_{wheat(bran)} = 90,384,615\times 0,22 = 19,884,615
\end{equation}

Moreover: 

\begin{equation}
\label{eq:shareEx1}
s^{2}_{Gluten,wheat} = \frac{5,796,652}{5,796,652 + 1,803,440} = 0.76
\end{equation}
\begin{equation}
\label{eq:shareEx1}
s^{2}_{Gluten,Maize} = \frac{1,803,440}{5,796,652 + 1,803,440} = 0.24
\end{equation}

By applying equations \ref{eq:Food Processing} to \ref{eq:availability2} to `r table_nums("t14",display = "cite")`, `r table_nums("t18",display = "cite")` is obtained, which contains the so *Standardized* Table, while the DES for the *Sua Standardized* of `r table_nums("t18",display = "cite")` is reported in `r table_nums("t20",display = "cite")`.


```{r t20, fig.cap=t20_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/20_desSuaStandardized.csv"),check.names = FALSE)
knitr::kable(table,caption = "DES of *Sua Standardized* - China/Wheat/2014 example",
             align = c(rep("c",length(colnames(table))-1)))

```

Notice that *Production* remains untouched from the Standardization process and *ROU* are still untouched.


## The "Fbs Standardized" table {-}

The standardized table is called *Fbs Standardized* and is composed of more than 1 line, because, besides the primary commodity there are 2 more typologies of commodities, both : 

 * *No-tree* commodities, that are also *"zero-level"* commodities, appear here as they were in the previous step. Indeed, as these are not processed, the standardization does not change any of the element's values.
 * *Proxy-primary* commodities. The Child commodities defined as *proxy-primary* are cut from their trees immediately before the standardization begins. They are treated as primary commodities and appear here together with the primaries. 

`r table_nums("t18",display = "cite")` and `r table_nums("t24",display = "cite")`

```{r t18, fig.cap=t18_cap}
table=data.table(read.csv("tables/StandBal/18_sua_standardized.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua Standardized",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down"))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  column_spec(2:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "10em")%>%
  add_footnote(c("P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses","Starred figures are those that have changed from the previous table"),notation = "alphabet")
```

# The FBS Balancing

The balancing of Standardized Sua in the new framework is based on the idea that, at this step of the overall process, a *little* imbalance has been cumulated, due to the errors of each variable. Therefore, equation \ref{eq:balance1} can be rewritten, in its balanced form, as: 


\begin{equation}
\label{eq:balance3}
P^*_{ijt} + I^*_{ijt} - X^*_{ijt} - \Delta St^*_{ijt} = FP^*_{ijt} + Fo^*_{ijt} + Fe^*_{ijt} + Lo^*_{ijt} + Se^*_{ijt} + IU^*_{ijt} + T^*_{ijt}  + ROU^*_{ijt}
\end{equation}

where (dropping the indices for brevity): 

 * $P^* = P \pm adj_{P}$
 * $I^* = I \pm adj_{I}$
 * $X^* = X \pm adj_{X}$
 * $\Delta St^* = \Delta St \pm adj_{\Delta St}$
 * $FP^* = FP \pm adj_{FP}$
 * $Fo^* = Fo \pm adj_{Fo}$
 * $Fe^* = Fe \pm adj_{Fe}$
 * $Lo^* = Lo \pm adj_{Lo}$
 * $Se^* = Se \pm adj_{Se}$
 * $IU^* = IU \pm adj_{IU}$
 * $T^* = T \pm adj_{T}$

and where each *adjustment ($adj_{el \in E}$)* is a balancing adjustment calculated satrting from the measurement error (*ME*) of each element $el \in E = \{P,I,X,\Delta St, FP,Fo,Fe,Lo,Se,IU,T,ROU\}$.

In particular, the balancing mechanism is a two step process aimed at modify each value proportionally to the *ME*. It start with the definition of the percentages of *Measurement Errors ($p_{ME}$)* for each element as reported in the following Table:

```{r t21, fig.cap=t21_cap, fig.pos = "H"}
table=data.table(read.csv("tables/StandBal/21_measurementErrors.csv",header = FALSE,check.names = FALSE))
knitr::kable(table,caption = "Measurement Errors percentages",
             align = c(rep("c",length(colnames(table))-1)),
             col.names = c("Element", "$p_{ME}$"))

```


$ROU$ is not included int his table because ROU is created in this step in a slightly different way. 

Indeed, the *final balancing* happens according to the following steps:

 **1.** If $Imb2 > 0$:
 
 * **1.a** If $Imb2 < TS \times 0.05$:
  
  >Residual and Other Uses is set equal to the Imbalance: 
  
  >$ROU = Imb2$ 
  
  >and the equation is balanced.
  
 * **1.b** If $Imb2 > TS \times 0.05$:
  
   * $ROU^* = TS \times 0.05$
   * $Imb2 = Imb2 - ROU^*$
   * The *$adj_{el \in E}$*s are given by: 

>>\begin{equation}
\label{eq:badj1}
adj_{el \in E} = Imb2 \times Value_{el} \times p_{adj_{el}}
\end{equation}

>>with 

>>\begin{equation}
\label{eq:badj2}
p_{adj_{el}} =\cfrac{p_{ME}}{\sum \limits_{el \in E} (Value_{el} \times p_{ME})}
\end{equation}

>>and 

>>\begin{equation}
\label{eq:badj3}
\sum \limits_{el \in E} p_{adj_{el}} = 1
\end{equation}


>>Equation \ref{eq:badj3} being assured by the two steps approach. 

 **2.** If Imbalance is Negative: $Imb2 < 0$ 

>*ROU* is not activated and the other elements are balanced accordingly to equations \ref{eq:badj1} to \ref{eq:badj3}

## Nutritive Values updates {-}

After the balancing happens, the value of Food availability might have changed, therefore, the Nutritive values have to be adjusted accordingly. The *Balanced Nutritive values* are obtained through a proportion. For the *DES*, this proportion is given by: 

$Fo^* : Fo = DES^* : DES \rightarrow DES* = DES \times \cfrac{Fo^*}{Fo}$

`r table_nums("t22",display = "cite")` reports all the steps of the final balancing in the China/Wheat/2014 example for *Wheat*, including the final adjustment of the DES. 


```{r t22, fig.cap=t22_cap, fig.pos = "H",results="asis"}
table=data.table(read.csv("tables/StandBal/22_sua_balancedW.csv",check.names = FALSE))
knitr::kable(table,caption = "Final Balancing - China/Wheat/2014 - Wheat", 
             align = c("r",rep("l",length(colnames(table))-1)))


```

The balancing of the commodity *Food Preparations of* is reported in `r table_nums("t24",display = "cite")`. In this case, the imbalance is positive and absorbed by the element *ROU*.


```{r t24, fig.cap=t24_cap, fig.pos = "H",results="asis"}
table=data.table(read.csv("tables/StandBal/24_sua_balancedF.csv",check.names = FALSE))
knitr::kable(table,caption = "Final Balancing - China/Wheat/2014 - Food Preparations", 
             align = c("r",rep("l",length(colnames(table))-1)))


```

# Final aggregation: FBS items and FBS aggregates

The Food Balance Sheets have to be expressed in *FBS* items.The conversion from CPC to FBS is a simple aggregation based on an aggregation table, called ***Fbs Tree***, an extract of which is reported in  `r table_nums("t23",display = "cite")`.

After the Balancing happens, the CPC commodities are aggregated on the basis of the classifications of FBS commodities reported in the table. 3 different level of aggregations are performed: 

 1. at FBS item level, 
 2. At FBS group level
 3. at FBS family level
 4. at the Total (By country) FBS Level.

`r table_nums("t25",display = "cite")` reports these aggregations for the China/Wheat/2014 example, including the DES. 

```{r t23, fig.cap=t23_cap, fig.pos = "H"}
```

\begin{table}[ht]
\caption {Fbs Tree [extraction of the main table]}
\centering
\resizebox{\columnwidth}{!}{
\begin{tabular}{l|l|l|l|l}
\toprule
\multicolumn{4}{c|}{\bf{FBS}} & \multicolumn{1}{c}{\bf{SUA}}\\ 
\midrule
\bf{TOTAL} & \bf{FAMILY} & \bf{GROUP} & \bf{ITEM} & \bf{P-P \& PROC*} \\ 
\midrule
\multirow{47}{*}{2901 GRAND TOTAL} & \multirow{37}{*}{2903  VEGETALE PRODUCTS}  & \multirow{22}{*}{2905 CEREALS (EXCLUDING BEER)} & \multirow{14}{*}{2511 WHEAT \& PRODUCTS}  & WHEAT \\ 
&  &  &  & FLOUR WHEAT \\ 
&  &  &  & BRAN WHEAT  \\ 
&  &  &  & MACARONI \\ 
&  &  &  & GERM WHEAT  \\ 
&  &  &  & BREAD \\ 
&  &  &  & BULGUR \\ 
&  &  &  & PASTRY \\ 
&  &  &  & WHEAT,STARCH \\ 
&  &  &  & WHEAT GLUTEN  \\ 
&  &  &  & BREAKF CERLS \\ 
&  &  &  & WAFERS \\ 
&  &  &  & MIXES AND DO  \\ 
&  &  &  & FOOD PREP.FL  \\ 
\cline{4-5}
&  &  &  \multirow{7}{*}{2514 MAIZE \& PRODUCTS}  & MAIZE \\ 
&  &  &  & GERM MAIZE  \\ 
&  &  &  & FLOUR MAIZE \\ 
&  &  &  & BRAN MAIZE  \\ 
&  &  &  & MAIZE GLUTEN  \\ 
&  &  &  & STARCH MAIZE \\ 
&  &  &  & GLUT FEED\& ME \\ 
&  &  &  &  \\
\cline{3-5}
&  & \multirow{11}{*}{2909 SWEETENERS} & \multirow{11}{*}{2543 SWEETENERS, OTHER \& PROD} & FRUCTOSE CHE \\ 
&  &  &  & MALTOSE CHEM \\ 
&  &  &  & MAPLE SUGAR \\ 
&  &  &  & SUGAR CROPS \\ 
&  &  &  & MOLASSES (calories \\ 
&  &  &  & OTHER FRUCTO \\ 
&  &  &  & SUGAR NES \\ 
&  &  &  & GLUC. DEXTR. \\ 
&  &  &  & LACTOSE \\ 
&  &  &  & ISOGLUCOSE \\ 
&  &  &   & BEV NON-ALC \\ 
&  &  &  &  \\
\cline{3-5}
&  & \multirow{2}{*}{2914 VEGETABLE OILS} & 2571 SOYABEAN, OIL & OIL SOYABEAN \\ 
&  &  & 2572 GROUNDNUT, OIL 2 & OIL GROUNDNT \\ 
&  &  &  &  \\
\cline{2-5}
& \multirow{10}{*}{2941  ANIMAL PRODUCTS}  & \multirow{10}{*}{2943 MEAT (SLAUGHTERED)}  & \multirow{10}{*}{2731 MEAT \& PRODUCTS BOVINE}  & BEEF VEAL \\ 
&  &   &  & BEEF BONLESS \\ 
&  &  &  & BEEF DSS \\ 
&  &  &  & MEAT EXTRACT \\ 
&  &  &  & SAUSAGE BEEF \\ 
&  &  &  & BEEF PREP \\ 
&  &  &  & BEEF CANNED \\ 
&  &  &  & HOMOGENIZED \\ 
&  &  &  & BUFFALO MEAT \\ 
&  &  &  &  \\
\bottomrule
\\
\multicolumn{5}{c|}{* P-P \& PROC stands for "Proxy-primaries and Processed commodities"}
\end{tabular}
}
\end{table}


```{r t25, fig.cap=t25_cap}
table=data.table(read.csv("tables/StandBal/25_FbsAggregationChina.csv"))
landscape(knitr::kable(table,format="latex",caption = "FBS Final Aggregations - China/Wheat/2014",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down"))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  column_spec(2:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "10em")%>%
  add_footnote("P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "alphabet")
```

# Room/needs for improvement  {-}

The methodology presented in this document is the result of the teamwork of the ESS *methodological team* and *data team*. Still some aspects of the methodology have to be fully tested and might require adjustments and/or debug. 

Some aspects that might need revision and/or update are: 

 1. How to manage the balancing of *stock variation* during the sua Filling. As said across the document, figures of stock variation are not touched during the sua filling. While this appeared the only way of treating stocks in the present version of the methodology, some effort might be taken in the future for letting also stock being included in the process.
 2. How to manage the imbalance. A check on the amount of imbalance might be added before the balancing happens, so to warn in case of huge imbalance, for the need of revision at input-data level.
 3. The user might need to change figures in the *sua unbalanced* table. If it happens, an additional module should exists that synchronize back the figures in the original data-sets. In this way, the new figures will be available the following year, as starting point of new imputations.

This methodology has been used for producing FBS of year 2016. 

